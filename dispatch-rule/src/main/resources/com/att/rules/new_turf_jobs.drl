package com.att.rules;

import com.att.dispatch.rule.model.Turf;
import com.att.dispatch.rule.model.Job;
import com.att.dispatch.rule.model.Group;
import com.att.dispatch.rule.model.Analytic;

global  com.att.dispatch.rule.process.JobPool job_pool
global  com.att.dispatch.rule.process.TurfPool turf_pool

/*********  PENDING RULE - starts here *******************/
rule "a pending job is added,create a status group"
no-loop true
when
    $job: Job( $id: id, $status: status == "PENDING" , $turfID : turfID)
    $turf: Turf( id ==  $turfID , $totalNumberOfJobs: totalNumberOfJobs,  $groups: groups)
    Boolean( booleanValue == false) from $groups.containsKey($status)
then 
    int value = 1;
   System.out.println("System not existing "+$status);
    //update the total number of jobs by 1
   $groups.put($status,new Group($status,value));
   $turf.setTotalNumberOfJobs( $turf.getTotalNumberOfJobs() +value)
    //modify($turf){setTotalNumberOfJobs( $totalNumberOfJobs +value)}  
    //update store and send message to notifier
    Message msg = new Message();
    msg.add("messages:turfs:jobs", job_pool.save($job));
    msg.add("messages:turfs", turf_pool.save($turf));
    insert(msg);
end

rule "a pending job is added, update existing group"
no-loop true
when
    $job: Job( $id: id, $turfID : turfID, $status: status == "PENDING")
    $turf: Turf( id == $turfID, $totalNumberOfJobs : totalNumberOfJobs, $groups: groups)
    Boolean(booleanValue == true) from $groups.containsKey($status)
then 
    //add new group
    int value = 1;
    System.out.println("System existing "+$status);
    //get the group value
    int newValue = ((Group)$groups.get($status)).getValue() + value;
    ((Group)$groups.get($status)).setValue(newValue);
    //update the total number of jobs by 1
    $turf.setTotalNumberOfJobs( $turf.getTotalNumberOfJobs() +value)
    //modify($turf){ setTotalNumberOfJobs( $totalNumberOfJobs +  value) }
    //update data store  and send message to notifier
    Message msg = new Message();
    msg.add("messages:turfs:jobs", job_pool.save($job));
    msg.add("messages:turfs", turf_pool.save($turf));
    insert(msg); 
end

/*******PENDING  here *******/